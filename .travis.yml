sudo: required
services:
- docker
language: bash
env:
  global:
    - JAVA_VERSION=jdk1.8.131
      HADOOP_VERSION=hadoop-2.7.3
      SPARK_VERSION=spark-2.2.1
      VERSION=${JAVA_VERSION}_${HADOOP_VERSION}_${SPARK_VERSION}
  matrix:
    - ARCH=amd64
      DOCKER_BUILD=danielrodriguez/docker-spark-debian
      DOCKERFILE=Dockerfile.x86_64
    - ARCH=arm
      DOCKER_BUILD=danielrodriguez/docker-spark-raspbian
      DOCKERFILE=Dockerfile.rpi
before_install:
- docker --version
- sudo apt-get remove docker-engine
- sudo apt-get -y install   apt-transport-https   ca-certificates   curl
- curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
- sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) edge"
- sudo apt-get update
- sudo apt-get -y install docker-ce=17.05.0~ce-0~ubuntu-trusty
- docker --version
script:
# prepare qemu
- >
  if [ "$ARCH" != "amd64" ]; then
    docker run --rm --privileged multiarch/qemu-user-static:register --reset
  fi
- docker version
# build image
- docker build -t ${DOCKER_BUILD}:${VERSION} -f ${DOCKERFILE} .
# test image
- docker run --rm ${DOCKER_BUILD}:${VERSION} /bin/echo "Success."
#- docker run --rm ${DOCKER_BUILD}:${VERSION} spark-shell --version
# push image
- >
  if [ "$TRAVIS_BRANCH" == "master" ] && [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
    docker login -u="$DOCKER_USER" -p="$DOCKER_PASS"
    docker tag ${DOCKER_BUILD}:${VERSION} ${DOCKER_BUILD}:latest
    docker push ${DOCKER_BUILD}:${VERSION}
    docker push ${DOCKER_BUILD}
  elif [ "$TRAVIS_BRANCH" != "master" ] && [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
    docker login -u="$DOCKER_USER" -p="$DOCKER_PASS"
    docker tag ${DOCKER_BUILD}:${VERSION} ${DOCKER_BUILD}:$TRAVIS_BRANCH
    docker push ${DOCKER_BUILD}:$TRAVIS_BRANCH
  fi

- echo '{"experimental":true}' | sudo tee /etc/docker/daemon.json
- sudo service docker restart
- docker version
- docker manifest create ${DOCKER_BUILD}:$TRAVIS_BRANCH
- docker manifest annotate ${DOCKER_BUILD}:$TRAVIS_BRANCH --arch $ARCH
- docker manifest push ${DOCKER_BUILD}:$TRAVIS_BRANCH
